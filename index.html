<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ShiftMind Academy - Facturation</title>

<!-- Styles Modernes -->
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 20px;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    background: white;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.1);
    overflow: hidden;
}

.header {
    background: linear-gradient(135deg, #2c3e50, #3498db);
    color: white;
    padding: 30px;
    text-align: center;
}

.header h1 {
    font-size: 2.5rem;
    margin-bottom: 10px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.nav-tabs {
    display: flex;
    background: #f8f9fa;
    border-bottom: 2px solid #e9ecef;
}

.nav-tab {
    flex: 1;
    padding: 15px 20px;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    color: #6c757d;
    transition: all 0.3s ease;
}

.nav-tab.active {
    background: white;
    color: #2c3e50;
    border-bottom: 3px solid #3498db;
}

.nav-tab:hover:not(.active) {
    background: #e9ecef;
    color: #495057;
}

.tab-content {
    display: none;
    padding: 30px;
    animation: fadeIn 0.5s ease;
}

.tab-content.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.form-group {
    margin-bottom: 20px;
}

label {
    display: block;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 8px;
}

input, select, textarea {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: white;
}

input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    transform: translateY(-1px);
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.btn {
    background: linear-gradient(135deg, #3498db, #2c3e50);
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 50px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.2);
}

.btn-secondary {
    background: linear-gradient(135deg, #95a5a6, #7f8c8d);
    margin-left: 10px;
    padding: 10px 20px;
    font-size: 0.9rem;
}

.invoice-preview {
    border: 2px solid #e9ecef;
    border-radius: 15px;
    padding: 30px;
    background: white;
    margin-top: 30px;
    display: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
}

.invoice-preview::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #3498db, #2c3e50);
}

.invoice-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid #3498db;
}

.invoice-header h2 {
    color: #2c3e50;
    font-size: 1.8rem;
    margin-bottom: 5px;
}

.invoice-header h3 {
    color: #3498db;
    font-size: 1.5rem;
}

.invoice-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin: 30px 0;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 10px;
}

.invoice-table {
    width: 100%;
    border-collapse: collapse;
    margin: 30px 0;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
}

.invoice-table th {
    background: linear-gradient(135deg, #3498db, #2c3e50);
    color: white;
    padding: 15px;
    text-align: left;
    font-weight: 600;
}

.invoice-table td {
    padding: 15px;
    border-bottom: 1px solid #e9ecef;
    background: white;
}

.invoice-table tr:hover td {
    background: #f8f9fa;
}

.total-section {
    text-align: right;
    margin-top: 30px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 10px;
}

.total-line {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    margin: 10px 0;
    font-size: 1.1rem;
}

.total-line strong {
    margin-left: 20px;
    min-width: 100px;
    text-align: right;
    color: #2c3e50;
}

.final-total {
    font-size: 1.3rem;
    color: #2c3e50;
    border-top: 2px solid #3498db;
    padding-top: 15px;
    margin-top: 15px;
    font-weight: 700;
}

.history-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
}

.history-table th {
    background: linear-gradient(135deg, #3498db, #2c3e50);
    color: white;
    padding: 15px;
    text-align: left;
    font-weight: 600;
}

.history-table td {
    padding: 12px 15px;
    border-bottom: 1px solid #e9ecef;
    background: white;
}

.history-table tr:hover td {
    background: #f8f9fa;
}

.history-actions {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    margin-bottom: 20px;
    gap: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
}

.history-actions label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
    color: #6c757d;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: linear-gradient(135deg, #3498db, #2c3e50);
    color: white;
    padding: 25px;
    border-radius: 15px;
    text-align: center;
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    transform: translateY(0);
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-card h3 {
    font-size: 2rem;
    margin-bottom: 10px;
}

input[type="number"]::-webkit-inner-spin-button, 
input[type="number"]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

input[type="file"] {
    padding: 8px;
    border: 2px dashed #3498db;
    background: #f8f9fa;
}

#invoice-notes {
    margin-top: 30px;
    padding: 20px;
    background: linear-gradient(135deg, #ecf0f1, #bdc3c7);
    border-radius: 10px;
    border-left: 4px solid #3498db;
}

@media (max-width: 768px) {
    body {
        padding: 10px;
    }
    
    .container {
        border-radius: 15px;
    }
    
    .header {
        padding: 20px;
    }
    
    .header h1 {
        font-size: 2rem;
    }
    
    .tab-content {
        padding: 20px;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .invoice-details {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .invoice-header {
        flex-direction: column;
        text-align: center;
        gap: 20px;
    }
    
    .history-actions {
        flex-direction: column;
        align-items: stretch;
    }
    
    .nav-tab {
        padding: 12px;
        font-size: 0.9rem;
    }
}

/* Animations d'entr√©e */
.form-group {
    animation: slideInUp 0.6s ease forwards;
    opacity: 0;
}

.form-group:nth-child(1) { animation-delay: 0.1s; }
.form-group:nth-child(2) { animation-delay: 0.2s; }
.form-group:nth-child(3) { animation-delay: 0.3s; }

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Effets de survol */
.invoice-table tr {
    transition: all 0.3s ease;
}

.history-table tr {
    transition: all 0.3s ease;
}

/* Style pour les messages de succ√®s */
.success-message {
    background: linear-gradient(135deg, #27ae60, #2ecc71);
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    margin: 20px 0;
    text-align: center;
    font-weight: 600;
    box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
}
</style>

<!-- Librairies -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<div class="container">

    <!-- Header -->
    <div class="header">
        <h1>üöÄ ShiftMind Academy</h1>
        <p>Syst√®me de Facturation Professionnel</p>
    </div>

    <!-- Onglets -->
    <div class="nav-tabs">
        <button class="nav-tab active" onclick="showTab('create')">üìÑ Cr√©er Facture</button>
        <button class="nav-tab" onclick="showTab('history')">üìä Historique</button>
        <button class="nav-tab" onclick="showTab('settings')">‚öôÔ∏è Param√®tres</button>
    </div>

    <!-- Onglet Cr√©ation -->
    <div id="create-tab" class="tab-content active">
        <h2 style="margin-bottom: 30px; color: #2c3e50; font-size: 2rem;">üî• Nouvelle Facture</h2>
        <form id="invoice-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="client-name">Nom du Client *</label>
                    <input type="text" id="client-name" required placeholder="Nom complet du client">
                </div>
                <div class="form-group">
                    <label for="client-email">Email du Client *</label>
                    <input type="email" id="client-email" required placeholder="email@exemple.com">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="client-country">Pays du Client</label>
                    <select id="client-country">
                        <option value="France">üá´üá∑ France</option>
                        <option value="Belgique">üáßüá™ Belgique</option>
                        <option value="Suisse">üá®üá≠ Suisse</option>
                        <option value="Canada">üá®üá¶ Canada</option>
                        <option value="Maroc">üá≤üá¶ Maroc</option>
                        <option value="Autre">üåç Autre</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="formation-type">Type de Formation *</label>
                    <select id="formation-type" required>
                        <option value="">S√©lectionner une formation</option>
                        <option value="Marketing Digital - 299">üéØ Marketing Digital - 299‚Ç¨</option>
                        <option value="E-commerce - 399">üõí E-commerce - 399‚Ç¨</option>
                        <option value="Leadership - 499">üëë Leadership - 499‚Ç¨</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="unit-price">Prix Unitaire (‚Ç¨) *</label>
                    <input type="number" id="unit-price" step="0.01" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label for="quantity">Quantit√© *</label>
                    <input type="number" id="quantity" value="1" min="1">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="tax-rate">Taux de TVA (%)</label>
                    <select id="tax-rate">
                        <option value="0">0% (Exon√©r√©)</option>
                        <option value="20" selected>20% (Standard)</option>
                        <option value="21">21% (Belgique)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="payment-method">Mode de Paiement</label>
                    <select id="payment-method">
                        <option value="Money Fusion">üí∞ Money Fusion</option>
                        <option value="Virement">üè¶ Virement Bancaire</option>
                        <option value="PayPal">üí≥ PayPal</option>
                        <option value="Esp√®ces">üíµ Esp√®ces</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="notes">Notes / Mentions L√©gales (Optionnel)</label>
                <textarea id="notes" rows="3" placeholder="Conditions de paiement, mentions l√©gales..."></textarea>
            </div>
            <div style="text-align:center; margin-top:30px;">
                <button type="submit" class="btn">üöÄ Cr√©er la Facture</button>
                <button type="button" class="btn btn-secondary" onclick="resetForm()">üîÑ Reset</button>
            </div>
        </form>

        <!-- Aper√ßu Facture -->
        <div id="invoice-preview" class="invoice-preview">
            <div class="invoice-header">
                <div style="display:flex; align-items:center;">
                    <img id="company-logo-preview" src="" alt="Logo" style="max-width:100px; max-height:80px; margin-right:15px; display:none;">
                    <div>
                        <h2 id="company-name">üöÄ ShiftMind Academy</h2>
                        <p id="company-address" style="color: #6c757d; margin-top: 5px;">123 Avenue de l'Innovation, 75001 Paris</p>
                        <p style="color: #6c757d; font-size: 0.9rem; margin-top: 5px;">
                            üìß contact@shiftmindacademy.com ‚Ä¢ üìû +33 1 23 45 67 89
                        </p>
                    </div>
                </div>
                <div style="text-align: right;">
                    <h3 id="invoice-number">Facture #2025-001</h3>
                    <p id="invoice-date" style="color: #6c757d; margin-top: 5px;">Date: 19/09/2025</p>
                </div>
            </div>

            <div class="invoice-details">
                <div>
                    <h4 style="color: #2c3e50; margin-bottom: 10px;">üíº Facturer √† :</h4>
                    <strong id="display-client-name" style="font-size: 1.1rem;">Nom Client</strong><br>
                    <span id="display-client-email" style="color: #6c757d;">email@exemple.com</span><br>
                    <span id="display-client-country" style="color: #6c757d;">Pays</span>
                </div>
                <div>
                    <h4 style="color: #2c3e50; margin-bottom: 10px;">üí≥ D√©tails de Paiement :</h4>
                    <p><strong>Mode :</strong> <span id="display-payment-method">Virement</span></p>
                    <p><strong>√âch√©ance :</strong> <span id="due-date">19/10/2025</span></p>
                </div>
            </div>

            <table class="invoice-table">
                <thead>
                    <tr>
                        <th>Description</th>
                        <th>Prix Unitaire</th>
                        <th>Quantit√©</th>
                        <th>Total HT</th>
                    </tr>
                </thead>
                <tbody id="invoice-items"></tbody>
            </table>

            <div class="total-section">
                <div class="total-line">
                    <span>Sous-total HT :</span>
                    <strong id="subtotal">0,00 ‚Ç¨</strong>
                </div>
                <div class="total-line">
                    <span>TVA (<span id="display-tax-rate">20</span>%) :</span>
                    <strong id="tax-amount">0,00 ‚Ç¨</strong>
                </div>
                <div class="total-line final-total">
                    <span><strong>üí∞ Total TTC :</strong></span>
                    <strong id="total-amount">0,00 ‚Ç¨</strong>
                </div>
            </div>

            <div id="invoice-notes" style="display:none;">
                <h4 style="margin-bottom: 10px; color: #2c3e50;">üìù Notes :</h4>
                <p id="display-notes"></p>
            </div>

            <div style="text-align:center; margin-top:30px;">
                <button onclick="generatePDF()" class="btn">üìÑ T√©l√©charger PDF</button>
                <button onclick="sendByEmail()" class="btn btn-secondary">üìß Envoyer Email</button>
            </div>
        </div>
    </div>

    <!-- Onglet Historique -->
    <div id="history-tab" class="tab-content">
        <h2 style="margin-bottom: 30px; color: #2c3e50; font-size: 2rem;">üìä Historique des Factures</h2>
        
        <div class="stats-grid">
            <div class="stat-card">
                <h3 id="total-invoices-count">0</h3>
                <p>Factures Cr√©√©es</p>
            </div>
            <div class="stat-card">
                <h3 id="total-revenue">0,00 ‚Ç¨</h3>
                <p>Chiffre d'Affaires</p>
            </div>
        </div>

        <div class="history-actions">
            <label>
                Supprimer apr√®s (jours):
                <input type="number" id="storage-days" value="30" min="1" style="width:80px; padding:8px; border-radius:5px; border:1px solid #ccc;">
            </label>
            <button class="btn-secondary" onclick="clearHistory()">üóëÔ∏è Supprimer tout</button>
        </div>
        
        <table class="history-table">
            <thead>
                <tr>
                    <th>N¬∞ Facture</th>
                    <th>Client</th>
                    <th>Montant</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="history-body">
                <tr>
                    <td colspan="5" style="text-align: center; color: #6c757d; padding: 40px;">
                        üìÑ Aucune facture cr√©√©e pour le moment
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Onglet Param√®tres -->
    <div id="settings-tab" class="tab-content">
        <h2 style="margin-bottom: 30px; color: #2c3e50; font-size: 2rem;">‚öôÔ∏è Param√®tres de l'Acad√©mie</h2>
        <form id="settings-form">
            <div class="form-group">
                <label for="setting-company-logo">üñºÔ∏è Logo de l'Entreprise</label>
                <input type="file" id="setting-company-logo" accept="image/*">
                <small style="color: #6c757d;">Formats accept√©s: JPG, PNG, SVG (Max 2MB)</small>
            </div>
            <div class="form-group">
                <label for="setting-company-name">üè¢ Nom de l'Entreprise</label>
                <input type="text" id="setting-company-name" value="üöÄ ShiftMind Academy">
            </div>
            <div class="form-group">
                <label for="setting-company-address">üìç Adresse Compl√®te</label>
                <textarea id="setting-company-address" rows="2">123 Avenue de l'Innovation, 75001 Paris</textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="setting-default-tax">üìä TVA par D√©faut (%)</label>
                    <input type="number" id="setting-default-tax" value="20" min="0" max="100">
                </div>
                <div class="form-group">
                    <label for="setting-invoice-prefix">üî¢ Pr√©fixe Factures</label>
                    <input type="text" id="setting-invoice-prefix" value="2025" maxlength="10">
                </div>
            </div>
            <div style="text-align:center; margin-top:30px;">
                <button type="button" class="btn" onclick="saveSettings()">üíæ Sauvegarder les Param√®tres</button>
                <button type="button" class="btn btn-secondary" onclick="resetSettings()">üîÑ R√©initialiser</button>
            </div>
        </form>
    </div>
</div>

<!-- Script -->
<script>
let invoiceCounter = 1;
let invoiceHistory = [];

// Onglets avec animations
function showTab(tabName){
    document.querySelectorAll('.tab-content').forEach(tab=>tab.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(tab=>tab.classList.remove('active'));
    document.getElementById(tabName+'-tab').classList.add('active');
    event.target.classList.add('active');
    
    // Mettre √† jour les stats quand on ouvre l'historique
    if(tabName === 'history') {
        updateStats();
    }
}

// Auto-remplissage du prix selon la formation
document.getElementById('formation-type').addEventListener('change', function(){
    const selected = this.value;
    if(selected) {
        const price = selected.match(/(\d+)/);
        if(price) {
            document.getElementById('unit-price').value = price[1];
        }
    }
});

// Cr√©ation facture avec validation am√©lior√©e
document.getElementById('invoice-form').addEventListener('submit', function(e){
    e.preventDefault();
    
    // Validation
    const clientName = document.getElementById('client-name').value.trim();
    const clientEmail = document.getElementById('client-email').value.trim();
    const formationType = document.getElementById('formation-type').value;
    const unitPrice = parseFloat(document.getElementById('unit-price').value);
    
    if(!clientName || !clientEmail || !formationType || !unitPrice || unitPrice <= 0) {
        showMessage('‚ùå Veuillez remplir tous les champs requis', 'error');
        return;
    }
    
    createInvoice();
});

function createInvoice() {
    const clientName = document.getElementById('client-name').value;
    const clientEmail = document.getElementById('client-email').value;
    const clientCountry = document.getElementById('client-country').value;
    const formationSelect = document.getElementById('formation-type').value;
    const formationType = formationSelect.split(' - ')[0];
    const unitPrice = parseFloat(document.getElementById('unit-price').value) || 0;
    const quantity = parseInt(document.getElementById('quantity').value) || 1;
    const taxRate = parseFloat(document.getElementById('tax-rate').value);
    const paymentMethod = document.getElementById('payment-method').value;
    const notes = document.getElementById('notes').value;

    const subtotal = unitPrice * quantity;
    const taxAmount = subtotal * taxRate / 100;
    const total = subtotal + taxAmount;

    const currentDate = new Date();
    const invoiceDate = currentDate.toLocaleDateString('fr-FR');
    const dueDate = new Date(currentDate.setMonth(currentDate.getMonth()+1)).toLocaleDateString('fr-FR');

    const invoiceNumberText = `Facture #2025-${String(invoiceCounter).padStart(3,'0')}`;
    
    // Mise √† jour de l'aper√ßu
    document.getElementById('invoice-number').textContent = invoiceNumberText;
    document.getElementById('invoice-date').textContent = `Date: ${invoiceDate}`;
    document.getElementById('due-date').textContent = dueDate;
    document.getElementById('display-client-name').textContent = clientName;
    document.getElementById('display-client-email').textContent = clientEmail;
    document.getElementById('display-client-country').textContent = clientCountry;
    document.getElementById('display-payment-method').textContent = paymentMethod;
    document.getElementById('display-tax-rate').textContent = taxRate;

    document.getElementById('invoice-items').innerHTML = `
        <tr>
            <td style="font-weight: 600;">${formationType}</td>
            <td>${unitPrice.toFixed(2)} ‚Ç¨</td>
            <td style="text-align: center;">${quantity}</td>
            <td style="font-weight: 600;">${subtotal.toFixed(2)} ‚Ç¨</td>
        </tr>
    `;
    
    document.getElementById('subtotal').textContent = `${subtotal.toFixed(2)} ‚Ç¨`;
    document.getElementById('tax-amount').textContent = `${taxAmount.toFixed(2)} ‚Ç¨`;
    document.getElementById('total-amount').textContent = `${total.toFixed(2)} ‚Ç¨`;

    if(notes.trim()){ 
        document.getElementById('display-notes').textContent = notes;
        document.getElementById('invoice-notes').style.display='block';
    } else {
        document.getElementById('invoice-notes').style.display='none';
    }

    // Afficher l'aper√ßu avec animation
    const preview = document.getElementById('invoice-preview');
    preview.style.display='block';
    setTimeout(() => {
        preview.scrollIntoView({ behavior: 'smooth' });
    }, 100);

    // Ajouter √† l'historique
    invoiceHistory.unshift({
        id: invoiceCounter,
        number: invoiceNumberText,
        client: clientName,
        email: clientEmail,
        formation: formationType,
        total: total.toFixed(2),
        date: invoiceDate,
        subtotal: subtotal,
        taxAmount: taxAmount,
        paymentMethod: paymentMethod,
        notes: notes
    });
    
    updateHistoryTable();
    showMessage('‚úÖ Facture cr√©√©e avec succ√®s !', 'success');

    invoiceCounter++;
}

// Fonction pour afficher les messages
function showMessage(text, type = 'success') {
    const existingMessage = document.querySelector('.success-message, .error-message');
    if(existingMessage) existingMessage.remove();
    
    const message = document.createElement('div');
    message.className = type === 'success' ? 'success-message' : 'error-message';
    message.textContent = text;
    
    const form = document.getElementById('invoice-form');
    form.parentNode.insertBefore(message, form);
    
    setTimeout(() => {
        message.remove();
    }, 4000);
}

// Historique avec statistiques
function updateHistoryTable(){
    const tbody = document.getElementById('history-body');
    
    if(invoiceHistory.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center; color: #6c757d; padding: 40px;">
                    üìÑ Aucune facture cr√©√©e pour le moment
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = '';
    invoiceHistory.forEach((inv, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td style="font-weight: 600; color: #3498db;">${inv.number}</td>
            <td>${inv.client}</td>
            <td style="font-weight: 600; color: #27ae60;">${inv.total} ‚Ç¨</td>
            <td>${inv.date}</td>
            <td>
                <button class="btn-secondary" onclick="viewInvoice(${index})" style="margin: 2px;">üëÅÔ∏è Voir</button>
                <button class="btn-secondary" onclick="duplicateInvoice(${index})" style="margin: 2px;">üìã Dupliquer</button>
                <button class="btn-secondary" onclick="deleteInvoice(${index})" style="margin: 2px; background: #e74c3c;">üóëÔ∏è Suppr.</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Mettre √† jour les statistiques
function updateStats() {
    const totalInvoices = invoiceHistory.length;
    const totalRevenue = invoiceHistory.reduce((sum, inv) => sum + parseFloat(inv.total), 0);
    
    document.getElementById('total-invoices-count').textContent = totalInvoices;
    document.getElementById('total-revenue').textContent = `${totalRevenue.toFixed(2)} ‚Ç¨`;
}

// Voir une facture
function viewInvoice(index) {
    const invoice = invoiceHistory[index];
    if(!invoice) return;
    
    // Remplir le formulaire avec les donn√©es
    document.getElementById('client-name').value = invoice.client;
    document.getElementById('client-email').value = invoice.email;
    document.getElementById('formation-type').value = invoice.formation + ' - ' + invoice.subtotal;
    document.getElementById('unit-price').value = invoice.subtotal;
    document.getElementById('quantity').value = '1';
    document.getElementById('payment-method').value = invoice.paymentMethod;
    document.getElementById('notes').value = invoice.notes || '';
    
    // Changer vers l'onglet cr√©ation
    showTab('create');
    document.querySelector('[onclick="showTab(\'create\')"]').click();
    
    // Recr√©er l'aper√ßu
    setTimeout(() => {
        createInvoice();
    }, 100);
}

// Dupliquer une facture
function duplicateInvoice(index) {
    viewInvoice(index);
    // Effacer l'aper√ßu pour forcer une nouvelle cr√©ation
    document.getElementById('invoice-preview').style.display = 'none';
    showMessage('üìã Facture dupliqu√©e ! Modifiez les informations si n√©cessaire.', 'success');
}

// Supprimer facture avec confirmation
function deleteInvoice(index){
    const invoice = invoiceHistory[index];
    if(confirm(`Supprimer la facture ${invoice.number} pour ${invoice.client} ?`)){
        invoiceHistory.splice(index, 1);
        updateHistoryTable();
        updateStats();
        showMessage('üóëÔ∏è Facture supprim√©e avec succ√®s', 'success');
    }
}

// Supprimer tout l'historique
function clearHistory(){
    if(confirm("‚ö†Ô∏è Supprimer TOUT l'historique des factures ? Cette action est irr√©versible.")){
        invoiceHistory = [];
        updateHistoryTable();
        updateStats();
        showMessage('üóëÔ∏è Historique vid√© avec succ√®s', 'success');
    }
}

// Gestion automatique du stockage par jours
setInterval(()=>{
    const daysLimit = parseInt(document.getElementById('storage-days').value) || 30;
    const now = new Date();
    const initialCount = invoiceHistory.length;
    
    invoiceHistory = invoiceHistory.filter(inv => {
        const invDate = new Date(inv.date.split('/').reverse().join('-'));
        const diffDays = (now - invDate)/(1000*60*60*24);
        return diffDays <= daysLimit;
    });
    
    const deletedCount = initialCount - invoiceHistory.length;
    if(deletedCount > 0) {
        updateHistoryTable();
        updateStats();
        console.log(`üóëÔ∏è ${deletedCount} facture(s) supprim√©e(s) automatiquement (>${daysLimit} jours)`);
    }
}, 3600000); // V√©rifie toutes les heures

// Gestion du logo
document.getElementById('setting-company-logo').addEventListener('change', function(e){
    const file = e.target.files[0];
    if(file){
        if(file.size > 2 * 1024 * 1024) {
            showMessage('‚ùå Le fichier doit faire moins de 2MB', 'error');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(ev){
            const logoPreview = document.getElementById('company-logo-preview');
            logoPreview.src = ev.target.result;
            logoPreview.style.display = 'block';
            showMessage('‚úÖ Logo charg√© avec succ√®s !', 'success');
        }
        reader.readAsDataURL(file);
    }
});

// Sauvegarder les param√®tres
function saveSettings(){
    const name = document.getElementById('setting-company-name').value;
    const address = document.getElementById('setting-company-address').value;
    const tax = document.getElementById('setting-default-tax').value;

    document.getElementById('company-name').textContent = name;
    document.getElementById('company-address').textContent = address;
    document.getElementById('tax-rate').value = tax;
    
    // Sauvegarder dans localStorage
    localStorage.setItem('company-name', name);
    localStorage.setItem('company-address', address);
    localStorage.setItem('default-tax', tax);
    
    showMessage('‚öôÔ∏è Param√®tres sauvegard√©s avec succ√®s !', 'success');
}

// R√©initialiser les param√®tres
function resetSettings() {
    if(confirm('üîÑ R√©initialiser tous les param√®tres aux valeurs par d√©faut ?')) {
        document.getElementById('setting-company-name').value = 'üöÄ ShiftMind Academy';
        document.getElementById('setting-company-address').value = '123 Avenue de ';
        document.getElementById('setting-default-tax').value = '20';
        document.getElementById('company-logo-preview').style.display = 'none';
        
        localStorage.removeItem('company-name');
        localStorage.removeItem('company-address');
        localStorage.removeItem('default-tax');
        
        showMessage('üîÑ Param√®tres r√©initialis√©s !', 'success');
    }
}

// R√©initialiser le formulaire
function resetForm() {
    document.getElementById('invoice-form').reset();
    document.getElementById('quantity').value = '1';
    document.getElementById('tax-rate').value = '20';
    document.getElementById('invoice-preview').style.display = 'none';
    showMessage('üîÑ Formulaire r√©initialis√©', 'success');
}

// G√©n√©ration PDF am√©lior√©e
function generatePDF(){
    const { jsPDF } = window.jspdf;
    const element = document.getElementById('invoice-preview');
    
    showMessage('üìÑ G√©n√©ration du PDF en cours...', 'success');
    
    html2canvas(element, { 
        scale: 2,
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#ffffff'
    }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('p','mm','a4');
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const imgWidth = pageWidth;
        const imgHeight = canvas.height * imgWidth / canvas.width;
        
        let heightLeft = imgHeight;
        let position = 0;
        
        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        
        while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
        }
        
        const invoiceNumber = document.getElementById('invoice-number').textContent.replace('Facture #','');
        const clientName = document.getElementById('display-client-name').textContent;
        const filename = `Facture_${invoiceNumber}_${clientName.replace(/\s+/g, '_')}.pdf`;
        
        pdf.save(filename);
        showMessage('‚úÖ PDF t√©l√©charg√© avec succ√®s !', 'success');
    }).catch(error => {
        console.error('Erreur PDF:', error);
        showMessage('‚ùå Erreur lors de la g√©n√©ration du PDF', 'error');
    });
}

// Envoyer par email
function sendByEmail() {
    const clientEmail = document.getElementById('client-email').value;
    const clientName = document.getElementById('display-client-name').textContent;
    const invoiceNumber = document.getElementById('invoice-number').textContent;
    const totalAmount = document.getElementById('total-amount').textContent;
    const dueDate = document.getElementById('due-date').textContent;

    const subject = `${invoiceNumber} - ShiftMind Academy`;
    const body = `Bonjour ${clientName},

Veuillez trouver ci-joint votre facture ${invoiceNumber.replace('Facture #', '')} d'un montant de ${totalAmount}.

D√©tails de la formation :
${document.getElementById('formation-type').value.split(' - ')[0]}

Mode de paiement : ${document.getElementById('display-payment-method').textContent}
Date d'√©ch√©ance : ${dueDate}

Merci pour votre confiance !

Cordialement,
L'√©quipe ShiftMind Academy

---
üöÄ ShiftMind Academy
üìß contact@shiftmindacademy.com
üìû +33 1 23 45 67 89
    `;

    const mailtoLink = `mailto:${clientEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.location.href = mailtoLink;

    showMessage('üìß Client email ouvert avec la facture pr√©-remplie !', 'success');
}

// Charger les param√®tres au d√©marrage
document.addEventListener('DOMContentLoaded', function() {
    // Charger les param√®tres sauvegard√©s
    const savedName = localStorage.getItem('company-name');
    const savedAddress = localStorage.getItem('company-address');
    const savedTax = localStorage.getItem('default-tax');
    
    if(savedName) {
        document.getElementById('setting-company-name').value = savedName;
        document.getElementById('company-name').textContent = savedName;
    }
    if(savedAddress) {
        document.getElementById('setting-company-address').value = savedAddress;
        document.getElementById('company-address').textContent = savedAddress;
    }
    if(savedTax) {
        document.getElementById('setting-default-tax').value = savedTax;
        document.getElementById('tax-rate').value = savedTax;
    }
    
    updateStats();
});

// Raccourcis clavier
document.addEventListener('keydown', function(e) {
    // Ctrl + N pour nouvelle facture
    if (e.ctrlKey && e.key === 'n') {
        e.preventDefault();
        showTab('create');
        document.querySelector('[onclick="showTab(\'create\')"]').click();
        resetForm();
    }
    
    // Ctrl + H pour historique
    if (e.ctrlKey && e.key === 'h') {
        e.preventDefault();
        showTab('history');
        document.querySelector('[onclick="showTab(\'history\')"]').click();
    }
});

// Style pour les messages d'erreur
const errorStyle = `
.error-message {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    margin: 20px 0;
    text-align: center;
    font-weight: 600;
    box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
}
`;

// Ajouter le style d'erreur
const style = document.createElement('style');
style.textContent = errorStyle;
document.head.appendChild(style);

console.log('üöÄ ShiftMind Academy - Syst√®me de Facturation charg√© avec succ√®s !');
</script>

</body>
</html>
